{"version":"0.3.0","body":"function main(workbook: ExcelScript.Workbook) {\n  const src = workbook.getActiveWorksheet();\n\n  // 1) Pre-processing\n\n  // Remove existing filter once\n  const af = src.getAutoFilter();\n  if (af) { try { af.remove(); } catch {} }\n  \n  // Unhide all\n  let xrange = src.getRange(\"A1:CZ65000\");\n  xrange.setColumnHidden(false);\n  xrange.setRowHidden(false);\n\n  const used = src.getUsedRange(true);\n  if (!used) return;\n\n  const rowCount = used.getRowCount();\n  const colCount = used.getColumnCount();\n  const startRow = used.getRowIndex();     // zero-based sheet row of used start\n  const startCol = used.getColumnIndex();  // zero-based sheet col of used start\n\n  // Convert whole data range into Table for copy filtered rows between sheets function\n  const fullDataRange = src.getRangeByIndexes(1, 0, Math.max(rowCount - 1, 0), colCount);\n  const tempTableName = \"TempFilteredTable\";\n  let tempTable = workbook.getTable(tempTableName);\n  if (tempTable) {\n    tempTable.delete();\n  }\n  tempTable = workbook.addTable(fullDataRange, true); // true = has headers\n  tempTable.setName(tempTableName);\n\n  // Clear trailing columns based on row 2 (header)\n  if (rowCount >= 2) {\n    const headerRowIdxInUsed = 1;\n    const row2Vals = used.getCell(headerRowIdxInUsed, 0).getResizedRange(0, colCount - 1).getValues()[0];\n    let lastUsedColInRow2 = -1;\n    for (let c = 0; c < colCount; c++) {\n      const v = row2Vals[c];\n      if (v !== null && v !== \"\" && v !== undefined) lastUsedColInRow2 = c;\n    }\n    if (lastUsedColInRow2 >= 0 && lastUsedColInRow2 < colCount - 1) {\n      const startCell = used.getCell(headerRowIdxInUsed, lastUsedColInRow2 + 1);\n      const toClear = startCell.getResizedRange(0, colCount - lastUsedColInRow2 - 2);\n      toClear.clear(ExcelScript.ClearApplyTo.all);\n    }\n  }\n\n  // Clear trailing rows based on first column in used range\n  const firstColVals = used.getCell(0, 0).getResizedRange(rowCount - 1, 0).getValues().map(r => r[0]);\n  let lastUsedRowInFirstCol = -1;\n  for (let r = 0; r < rowCount; r++) {\n    const v = firstColVals[r];\n    if (v !== null && v !== \"\" && v !== undefined) lastUsedRowInFirstCol = r;\n  }\n  if (lastUsedRowInFirstCol >= 0 && lastUsedRowInFirstCol < rowCount - 1) {\n    const startCell = used.getCell(lastUsedRowInFirstCol + 1, 0);\n    const toClear = startCell.getResizedRange(rowCount - lastUsedRowInFirstCol - 2, colCount - 1);\n    toClear.clear(ExcelScript.ClearApplyTo.all);\n  }\n\n  // 2) Filtering with header at row 2 (sheet index = startRow + 1)\n  const headerSheetRow = startRow + 1;\n  const headerRange = src.getRangeByIndexes(headerSheetRow, startCol, 1, colCount);\n  const header = headerRange.getValues()[0];\n\n  const colByHeader = (name: string): number => {\n    for (let i = 0; i < header.length; i++) {\n      if (header[i] === name) return i;\n    }\n    return -1;\n  };\n\n  // Filter range: row 2 through end\n  const filterRange = tempTable.getRange();\n  tempTable.getAutoFilter().apply(filterRange);\n\n  const colStatus = colByHeader(\"RICEFW Status\");\n  const colPhase = colByHeader(\"Phase\");\n  const colBaseline = colByHeader(\"Baseline Scope\");\n  const colJInUsed = 9; // column J relative to used range (zero-based)\n  const colJSheet = startCol + colJInUsed;\n\n  // Status = Approved\n  if (colStatus >= 0) {\n    tempTable.getAutoFilter().apply(filterRange, colStatus, {\n      filterOn: ExcelScript.FilterOn.values,\n      values: [\"Approved\"]\n    });\n  }\n\n  // Phase = Phase 1\n  if (colPhase >= 0) {\n    tempTable.getAutoFilter().apply(filterRange, colPhase, {\n      filterOn: ExcelScript.FilterOn.values,\n      values: [\"Phase 1\"]\n    });\n  }\n\n  // Baseline Scope = blank\n  if (colBaseline >= 0) {\n    tempTable.getAutoFilter().apply(filterRange, colBaseline, {\n      filterOn: ExcelScript.FilterOn.values,\n      values: [\"\"]\n    });\n  }\n\n  // Column J cumulative prefixes from ENTIRE column J in one shot (no per-row loop)\n  const prefixes = [\"RTR\", \"OTC_AR\", \"PTP_AP\"];\n  const dataStartSheetRow = headerSheetRow + 1; // row 3 (zero-based)\n  const jAllDataRange = src.getRangeByIndexes(dataStartSheetRow, colJSheet, Math.max(rowCount - 2, 0), 1);\n  const jAllValues2D = jAllDataRange.getValues(); // 2D read once\n  const matchJSet = new Set<string>();\n  for (let i = 0; i < jAllValues2D.length; i++) {\n    const val = jAllValues2D[i][0];\n    if (typeof val === \"string\" && val !== \"\") {\n      for (let p = 0; p < prefixes.length; p++) {\n        if (val.startsWith(prefixes[p])) {\n          matchJSet.add(val);\n          break;\n        }\n      }\n    }\n  }\n  const matchJ = Array.from(matchJSet);\n  if (matchJ.length > 0) {\n    tempTable.getAutoFilter().apply(filterRange, colJInUsed, {\n      filterOn: ExcelScript.FilterOn.values,\n      values: matchJ\n    });\n  }\n\n  // Get the latest view after filtered\n  const visibleView = tempTable.getRange().getVisibleView();\n  const visibleValues = visibleView.getValues();\n\n  // 3) Create destination next to the active sheet and copy only the filtered visible rows\n  const name = \"Matrix RICEFW\";\n  const existing = workbook.getWorksheet(name);\n  if (existing) existing.delete();\n  const dest = workbook.addWorksheet(name);\n  dest.setPosition(src.getPosition() + 1);\n\n  // Copy header (row 2 source â†’ row 1 destination)\n  dest.getRangeByIndexes(0, 0, 1, colCount)\n      .copyFrom(headerRange, ExcelScript.RangeCopyType.all, false, false);\n\n  // Copy visible filtered data (row 3 onward) exactly as shown\n  if (visibleValues.length > 1){\n    const dataValues = visibleValues.slice(1); // Remove header row\n    const visibleDataRowCount = dataValues.length;\n    const visibleDataColumnCount = visibleValues[0].length;\n    const destDataRange = dest.getRangeByIndexes(1, 0, visibleDataRowCount, visibleDataColumnCount);\n    destDataRange.setValues(dataValues);\n  }\n  // tempTable.delete(); // Clean up by deleting Temporary Table\n\n  // 4) Format destination\n  const destUsed = dest.getUsedRange(true);\n  if (destUsed && destUsed.getRowCount() > 1) {\n    dest.getRangeByIndexes(1, 0, destUsed.getRowCount() - 1, destUsed.getColumnCount())\n        .getFormat().getFill().clear();\n  }\n\n  dest.getRange().getFormat().setWrapText(false);\n  dest.getRange(\"A:L\").getFormat().autofitColumns();\n  dest.getRange(\"O:X\").getFormat().autofitColumns();\n  dest.getRange(\"Z:AB\").getFormat().autofitColumns();\n  dest.getRange(\"AE:ZZ\").getFormat().autofitColumns();\n  dest.getRange().getFormat().autofitRows();\n\n  setColWidth(dest, \"M:M\", 200);\n  setColWidth(dest, \"N:N\", 260);\n  setColWidth(dest, \"Y:Y\", 140);\n  setColWidth(dest, \"AC:AC\", 200);\n  setColWidth(dest, \"AD:AD\", 200);\n  setFill(dest, [\"Q1\", \"U1\", \"W1\", \"BD1\"], \"#00b050\");\n  setFill(dest, [\"X1\"], \"#00b0f0\");\n  setDate(dest, [\"AP:AP\", \"AS:AY\", \"BK:BL\", \"BQ:BT\", \"CA:CJ\"] );\n\n  // Fill column X for all destination data rows\n  const destUsed2 = dest.getUsedRange(true);\n  if (destUsed2) {\n    const totalRows = destUsed2.getRowCount();\n    const xColIdx = 23; // X zero-based\n    if (totalRows > 1) {\n      dest.getRangeByIndexes(1, xColIdx, totalRows - 1, 1)\n          .getFormat().getFill().setColor(\"#CAEDFB\");\n    }\n  }\n\n  // Destination AutoFilter\n  dest.getAutoFilter().apply(dest.getRange(\"A1\").getEntireRow());\n\n  // 5) Align entire destination\n  dest.getRange().getFormat().setWrapText(true);\n  dest.getRange().getFormat().autofitColumns();\n  dest.getRange().getFormat().setVerticalAlignment(ExcelScript.VerticalAlignment.center);\n\n  // 6) Sheet tab color red\n  dest.setTabColor(\"#FF0000\");\n\n  // 7) Final Format\n  dest.getRange(\"BE1:CL1\").getFormat().getFill().setColor(\"#800000\");\n  hideCols(dest, [\"A:G\", \"I:I\", \"AA:AB\", \"AE:AO\", \"BA:BC\", \"BV:BZ\", \"R:T\"]);\n  dest.getFreezePanes().freezeAt(dest.getRange(\"H1:J1\"));\n}\n\nfunction hideCols(sheet: ExcelScript.Worksheet, refs: string[]) {\n  for (let i = 0; i < refs.length; i++) {\n    sheet.getRange(refs[i]).setColumnHidden(true);\n  }\n}\n\nfunction setFill(sheet: ExcelScript.Worksheet, refs: string[], color: string) {\n  for (let i = 0; i < refs.length; i++) {\n    sheet.getRange(refs[i]).getFormat().getFill().setColor(color);\n  }\n}\n\nfunction setColWidth(sheet: ExcelScript.Worksheet, ref: string, width: number) {\n  sheet.getRange(ref).getFormat().setColumnWidth(width);\n}\n\nfunction setDate(sheet: ExcelScript.Worksheet, refs: string[]) {\n  for (let i = 0; i < refs.length; i++) {\n    sheet.getRange(refs[i]).setNumberFormatLocal(\"[$-en-US]d-mmm-yy;@\");\n  }\n}","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[],\"parameterSchema\":{\"type\":\"object\",\"default\":{},\"x-ms-visibility\":\"internal\"},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}